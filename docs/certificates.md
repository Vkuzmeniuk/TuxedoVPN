# Certificates (Let’s Encrypt / Certbot)

`ocserv` can run either:

- with **self-signed** certificates generated by the role (default), or
- with **public** certificates (recommended) from Let’s Encrypt / Certbot.

TLS mode is configured per host via `tuxedovpn_tls_mode` (recommended location: `host_vars/<host>.yml`):

```yaml
tuxedovpn_tls_mode: "selfsigned" # selfsigned | certbot
```

You can also set this as a global default in `group_vars/all/vars.yml` and override it per host as needed.

Both `group_vars/vpn.yml` and `group_vars/mgmt/vars.yml` derive `vpn_cert_use_existing` from this flag.

This repository includes a dedicated role `roles/certbot`.
When `tuxedovpn_tls_mode: "certbot"` is enabled and the expected certificate files are missing, VPN/service roles can auto-issue certificates via this role during a normal `site.yml` run.
No separate certificate-issuing playbooks are required.

## Domains and subdomains

- VPN gateways use `vpn_domain` from `host_vars/<vpn-host>.yml` as the TLS SNI name.
- mgmt web services typically use subdomains:
  - `grafana.<base-domain>`
  - `prometheus.<base-domain>`
  - `pihole.<base-domain>`

By default the mgmt base domain is taken from `vpn_domain` (in `host_vars/<mgmt-host>.yml`), but you can override it with `mgmt_services_base_domain`.

## mgmt reverse proxy (TLS termination for internal services)

The main playbook includes an optional role `roles/mgmt-reverse-proxy` that can publish:

- `grafana.<base-domain>` → `127.0.0.1:3000`
- `prometheus.<base-domain>` → `127.0.0.1:9090`
- `pihole.<base-domain>` → `127.0.0.1:80`

Enable on mgmt:

- `group_vars/mgmt/vars.yml`: `mgmt_reverse_proxy_enable: true`

It uses the same toggle (`tuxedovpn_tls_mode`). For `certbot` mode, make sure the issued certificate covers the services' subdomains (SAN or wildcard).

## Recommended challenge type

### DNS-01 (recommended)

Use DNS-01 when:

- VPN nodes are behind an L4 proxy (HAProxy tcp/SNI passthrough) and port 80 is not routed to the node.
- You need wildcard certificates (`*.example.com`).

You need to pass provider-specific auth parameters and (optionally) the contents of the credentials file via Ansible Vault.

Example (Cloudflare token):

- Vault:
  - `vault_certbot_email`
  - `vault_certbot_dns_credentials_ini` containing `dns_cloudflare_api_token = "..."`
- Extra vars:
  - `certbot_dns_plugin_packages: ["python3-certbot-dns-cloudflare"]`
  - `certbot_method: "dns"`
  - `certbot_auth_args`:
    - `--dns-cloudflare`
    - `--dns-cloudflare-credentials`
    - `/etc/letsencrypt/dns-credentials.ini`
    - `--dns-cloudflare-propagation-seconds`
    - `60`

### HTTP-01 (standalone, easiest with plain A-records)

Use this when:

- Your `vpn_domain` is an A-record pointing directly to the host public IP.
- Port `80/tcp` reaches the host directly (no HTTP reverse proxy/CDN in front that blocks `/.well-known/acme-challenge/`).
- You don't have DNS API credentials.

This uses Certbot in `standalone` mode (HTTP-01) on `:80`.
The role temporarily opens `tcp/80` via an iptables rule and can stop services bound to `:80` (for example `pihole-FTL`) during issuance/renewal.

## Issuing certificates (via `site.yml`)

### VPN gateways / ocserv

1. Set `tuxedovpn_tls_mode: "certbot"` in `host_vars/<vpn-host>.yml`.
2. Ensure `vault_certbot_email` is set (Ansible Vault).
3. Run:

```bash
ansible-playbook site.yml -l vpn -J
```

For mgmt/private ocserv on the mgmt host:

```bash
ansible-playbook site.yml -l mgmt -t private_vpn -J
```

### mgmt reverse proxy (Grafana/Prometheus/Pi-hole)

1. Enable the reverse proxy and set `mgmt_reverse_proxy_tls_mode: "certbot"`.
2. Ensure the service domains resolve to the mgmt host for ACME validation (or configure DNS-01).
3. Run:

```bash
ansible-playbook site.yml -l mgmt -t mgmt_reverse_proxy -J
```

## On-disk paths

VPN roles expect standard Let’s Encrypt paths:

- certificate: `/etc/letsencrypt/live/<domain>/fullchain.pem`
- private key: `/etc/letsencrypt/live/<domain>/privkey.pem`

For mgmt web services behind the built-in reverse proxy (`roles/mgmt-reverse-proxy`), the same toggle applies.
Make sure the issued certificate covers the services' subdomains (SAN or wildcard), for example:

- `grafana.<base-domain>`
- `prometheus.<base-domain>`
- `pihole.<base-domain>`

## Note about HAProxy (tcp/SNI passthrough for ocserv)

If an external HAProxy runs in `mode tcp` and routes ocserv by SNI, TLS is terminated on the VPN node.
In this setup certificates must live on the VPN nodes (DNS-01 is usually the easiest option).
