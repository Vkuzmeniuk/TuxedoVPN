# WireGuard mgmt↔vpn tunnel (`wg-mgmt`)

This repository uses a single WireGuard tunnel `wg-mgmt` for **all inter-server traffic between the management host(s) and VPN nodes**:

- DNS queries from VPN nodes to Pi-hole on mgmt
- RADIUS authentication/accounting from VPN nodes to FreeRADIUS on mgmt
- Prometheus scraping (node_exporter / ocserv exporter) via WireGuard IPs

The tunnel is created and maintained by the Ansible role `roles/mgmt-wireguard`.

## Topology

- Management host(s) listen on `UDP/51820` by default (`mgmt_wireguard_port`).
- VPN hosts connect to the management host as peers.
- The interface name on both sides is `wg-mgmt` (`mgmt_wireguard_interface`).

## Key management (automatic)

Keys are generated automatically **on each host** (no certificates and no manual paths):

- Private key: `/etc/wireguard/wg-mgmt.key`
- Public key: `/etc/wireguard/wg-mgmt.pub`
- Config: `/etc/wireguard/wg-mgmt.conf`

The service is managed by systemd:

- `wg-quick@wg-mgmt`

## Addressing

Default addressing is configured in `group_vars/all/vars.yml`:

- mgmt WireGuard IP: `mgmt_wireguard_address_mgmt` (default `10.202.0.1/24`)
- VPN node WireGuard IPs: auto-assigned from the same /24 in **inventory order**
  - `mgmt_wireguard_auto_assign_vpn_addresses: true`
  - `mgmt_wireguard_vpn_ip_start: 2` → the first VPN node gets `10.202.0.2`, then `10.202.0.3`, etc.

You can override WireGuard IP for a specific host in `host_vars/<host>.yml`:

```yaml
mgmt_wireguard_wireguard_address: "10.202.0.10/24"
```

## Routing model

Each VPN node must define its client subnet in `host_vars`:

```yaml
vpn_network_address: "10.66.1.0"
vpn_network_prefix_length: 24
```

On the management host, the WireGuard config adds routes for each client subnet:

- `ip route replace <vpn_subnet>/<prefix> dev wg-mgmt` (PostUp)
- `ip route del <vpn_subnet>/<prefix> dev wg-mgmt` (PostDown)

## What is allowed inside the tunnel

On mgmt, each VPN peer is allowed to send:

- its VPN client subnet (for example `10.66.1.0/24`)
- its WireGuard IP (for example `10.202.0.2/32`)

On VPN nodes, the peer is restricted to:

- only the mgmt WireGuard IP (for example `10.202.0.1/32`)

This keeps the tunnel strictly within mgmt↔vpn services.

## Service wiring

### VPN nodes

`group_vars/vpn.yml` points services to the management host WireGuard IP (`mgmt_wireguard_mgmt_ip`, derived from `mgmt_wireguard_address_mgmt`):

- RADIUS upstream: `vpn_radius_servers[].host: mgmt_wireguard_mgmt_ip`
- DNS for ocserv: `vpn_dns_servers: [mgmt_wireguard_mgmt_ip]`
- UFW: outgoing RADIUS/DNS rules are limited to `interface: wg-mgmt`

### Management host

- FreeRADIUS NAS clients are registered by the VPN nodes' WireGuard IPs (not public IPs).
- FreeRADIUS listens only on the mgmt WireGuard IP (not on `0.0.0.0` and not on localhost).
- Pi-hole DNS is allowed from:
  - mgmt's own VPN client subnet (regular interface)
  - remote VPN client subnets **only via** `wg-mgmt` (`pihole_dns_wireguard_only_sources`)
- UFW allows RADIUS from VPN nodes' WireGuard IPs **only on** `wg-mgmt`.

### Prometheus

Prometheus prefers scraping via WireGuard IP when available:

- `prometheus_prefer_mgmt_wireguard: true` (default in `roles/monitoring/defaults/main.yml`)

## Firewall model (UFW)

The base firewall role sets:

- deny incoming by default
- allow outgoing by default

Then services are exposed via an allowlist. For inter-server services, rules are limited to `interface: wg-mgmt` whenever possible.

## Verification (runbook)

After `ansible-playbook site.yml`:

- Check tunnel status:
  - `sudo wg show wg-mgmt`
  - `systemctl status wg-quick@wg-mgmt`
- On mgmt, verify routes to client subnets exist:
  - `ip route | grep wg-mgmt`
- Verify 51820/udp is listening on mgmt:
  - `ss -lun | grep :51820`

## Troubleshooting

- `RTNETLINK answers: Address already in use` during `wg-quick up` usually means UDP `51820` is already in use by another service or another WireGuard interface. Change `mgmt_wireguard_port` or free the port.
- If mgmt cannot bring peers up, verify VPN hosts are reachable and have `/etc/wireguard/wg-mgmt.pub` present (keys are generated by the role).
