server:
  http_listen_address: "{{ promtail_http_listen_address }}"
  http_listen_port: {{ promtail_http_listen_port | int }}
  grpc_listen_port: 0

positions:
  filename: "{{ promtail_positions_file }}"

clients:
  - url: "{{ promtail_loki_push_url }}"

scrape_configs:
  - job_name: syslog
    static_configs:
      - targets: [localhost]
        labels:
          job: syslog
          service: syslog
          service_name: syslog
          host: "{{ inventory_hostname }}"
          __path__: /var/log/syslog

  - job_name: auth
    static_configs:
      - targets: [localhost]
        labels:
          job: auth
          service: auth
          service_name: auth
          host: "{{ inventory_hostname }}"
          __path__: /var/log/auth.log

  - job_name: ocserv
    static_configs:
      - targets: [localhost]
        labels:
          job: ocserv
          service: ocserv
          service_name: ocserv
          host: "{{ inventory_hostname }}"
          __path__: "{{ promtail_ocserv_log_path }}"

{% if promtail_fail2ban_enable | default(false) | bool %}
  - job_name: fail2ban
    static_configs:
      - targets: [localhost]
        labels:
          job: fail2ban
          service: fail2ban
          service_name: fail2ban
          host: "{{ inventory_hostname }}"
          __path__: "{{ promtail_fail2ban_log_path }}"

{% endif %}
  - job_name: tuxedovpn_journal
    journal:
      max_age: "{{ promtail_journal_max_age }}"
      labels:
        job: journal
        host: "{{ inventory_hostname }}"
    relabel_configs:
      - source_labels: ['__journal__systemd_unit']
        regex: '(tuxedovpn-(dpi-agent|suricata|dpi-blocker|radius-pihole-sync)|freeradius)\\.service'
        action: keep
      - source_labels: ['__journal__systemd_unit']
        target_label: unit
      - source_labels: ['unit']
        regex: '(.+)'
        target_label: service_name
        replacement: '$1'
      - source_labels: ['unit']
        regex: '^(.+)\\.service$'
        target_label: service
        replacement: '$1'
      - source_labels: ['__journal__systemd_unit']
        regex: 'tuxedovpn-dpi-agent\\.service'
        target_label: job
        replacement: dpi
      - source_labels: ['__journal__systemd_unit']
        regex: 'tuxedovpn-dpi-agent\\.service'
        target_label: component
        replacement: dpi-agent
      - source_labels: ['__journal__systemd_unit']
        regex: 'tuxedovpn-dpi-agent\\.service'
        target_label: service
        replacement: dpi-agent
      - source_labels: ['__journal__systemd_unit']
        regex: 'tuxedovpn-dpi-blocker\\.service'
        target_label: job
        replacement: dpi
      - source_labels: ['__journal__systemd_unit']
        regex: 'tuxedovpn-dpi-blocker\\.service'
        target_label: component
        replacement: dpi-blocker
      - source_labels: ['__journal__systemd_unit']
        regex: 'tuxedovpn-dpi-blocker\\.service'
        target_label: service
        replacement: dpi-blocker
    pipeline_stages:
      - match:
          selector: '{job=~"journal|dpi"} |~ "^DPI_EVENT\\\\s+\\\\{"'
          stages:
            - regex:
                expression: '^DPI_EVENT\\s+(?P<dpi_json>\\{.*\\})$'
            - json:
                source: dpi_json
                expressions:
                  ts_utc: ts_utc
            - timestamp:
                source: ts_utc
                format: RFC3339Nano
                action_on_failure: skip

{% if 'vpn' in group_names %}
  - job_name: suricata_fast
    static_configs:
      - targets: [localhost]
        labels:
          job: suricata
          service: suricata
          service_name: suricata
          host: "{{ inventory_hostname }}"
          stream: fast
          __path__: /var/log/suricata/fast.log
{% if promtail_suricata_eve_enable | default(false) | bool %}

  - job_name: suricata_eve
    static_configs:
      - targets: [localhost]
        labels:
          job: suricata
          service: suricata
          service_name: suricata
          host: "{{ inventory_hostname }}"
          stream: eve
          __path__: /var/log/suricata/eve.json
{% endif %}
{% endif %}

{% if 'mgmt' in group_names %}
  - job_name: pihole
    static_configs:
      - targets: [localhost]
        labels:
          job: pihole
          service: pihole
          service_name: pihole
          host: "{{ inventory_hostname }}"
          __path__: /var/log/pihole/*.log

  - job_name: freeradius
    static_configs:
      - targets: [localhost]
        labels:
          job: freeradius
          service: freeradius
          service_name: freeradius
          host: "{{ inventory_hostname }}"
          __path__: /var/log/freeradius/*.log

  - job_name: nginx
    static_configs:
      - targets: [localhost]
        labels:
          job: nginx
          service: nginx
          service_name: nginx
          host: "{{ inventory_hostname }}"
          __path__: /var/log/nginx/*.log

  - job_name: grafana
    static_configs:
      - targets: [localhost]
        labels:
          job: grafana
          service: grafana
          service_name: grafana
          host: "{{ inventory_hostname }}"
          __path__: /var/log/grafana/grafana.log

  - job_name: postgresql
    static_configs:
      - targets: [localhost]
        labels:
          job: postgresql
          service: postgresql
          service_name: postgresql
          host: "{{ inventory_hostname }}"
          __path__: /var/log/postgresql/postgresql-*.log
{% endif %}
