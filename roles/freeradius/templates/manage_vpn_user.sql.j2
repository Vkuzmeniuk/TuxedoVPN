{% set username = freeradius_managed_vpn_username | replace("'", "''") %}
{% set password = freeradius_managed_vpn_password | replace("'", "''") %}
{% set authcheck_table = freeradius_sql_authcheck_table | default('radcheck') %}
WITH desired AS (
    SELECT '{{ username }}'::text AS username,
           '{{ password }}'::text AS password
),
existing AS (
    SELECT id, value
      FROM {{ authcheck_table }}
     WHERE username = (SELECT username FROM desired)
       AND attribute = 'Cleartext-Password'
       AND op = ':='
),
keeper AS (
    SELECT id
      FROM existing
     ORDER BY id
     LIMIT 1
),
duplicates AS (
    DELETE FROM {{ authcheck_table }}
     WHERE username = (SELECT username FROM desired)
       AND attribute = 'Cleartext-Password'
       AND op = ':='
       AND id <> COALESCE((SELECT id FROM keeper), -1)
    RETURNING 1
),
updated AS (
    UPDATE {{ authcheck_table }}
       SET value = (SELECT password FROM desired)
     WHERE id = (SELECT id FROM keeper)
       AND value <> (SELECT password FROM desired)
    RETURNING 1
),
inserted AS (
    INSERT INTO {{ authcheck_table }} (username, attribute, op, value)
    SELECT d.username, 'Cleartext-Password', ':=', d.password
      FROM desired d
     WHERE NOT EXISTS (SELECT 1 FROM keeper)
    RETURNING 1
)
SELECT 'USER_SYNC=' ||
       CASE
         WHEN EXISTS (SELECT 1 FROM duplicates)
           OR EXISTS (SELECT 1 FROM updated)
           OR EXISTS (SELECT 1 FROM inserted)
         THEN '1'
         ELSE '0'
       END;
