---
- name: Normalize target groups to list
  ansible.builtin.set_fact:
    _target_groups: "{{ (prometheus_target_groups | default(['vpn'])) | list }}"
  changed_when: false

- name: Normalize static targets to flat list
  ansible.builtin.set_fact:
    _static_targets: "{{ (prometheus_static_targets | default([])) | flatten | list }}"
  changed_when: false

- name: Normalize VPN target groups to list
  ansible.builtin.set_fact:
    _vpn_target_groups: ["vpn"]
  changed_when: false

# Prometheus
- name: Install Prometheus (Debian/Ubuntu)
  ansible.builtin.apt:
    name: prometheus
    state: present
    update_cache: true
    lock_timeout: "{{ apt_lock_timeout | default(600) | int }}"
  tags: ['monitoring_server']

- name: Render /etc/prometheus/prometheus.yml
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: /etc/prometheus/prometheus.yml
    owner: prometheus
    group: prometheus
    mode: "0644"
  notify: Restart Prometheus
  tags: ['monitoring_server']

- name: Ensure Prometheus enabled and started
  ansible.builtin.service:
    name: prometheus
    state: started
    enabled: true
  tags: ['monitoring_server']

# Grafana
- name: Install gnupg (for APT keyrings)
  ansible.builtin.apt:
    name: gnupg
    state: present
    lock_timeout: "{{ apt_lock_timeout | default(600) | int }}"
  when: ansible_pkg_mgr == "apt"
  tags: ['monitoring_server']

- name: Ensure /etc/apt/keyrings exists
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags: ['monitoring_server']

- name: Download Grafana GPG key (ASCII)
  ansible.builtin.get_url:
    url: https://apt.grafana.com/gpg.key
    dest: /etc/apt/keyrings/grafana.asc
    mode: "0644"
  register: _monitoring_grafana_key
  tags: ['monitoring_server']

- name: Check Grafana keyring exists (dearmored)
  ansible.builtin.stat:
    path: /etc/apt/keyrings/grafana.gpg
  register: _monitoring_grafana_keyring_stat
  changed_when: false
  tags: ['monitoring_server']

- name: Dearmor Grafana key into a keyring
  ansible.builtin.command: >-
    gpg --dearmor --yes
    --output /etc/apt/keyrings/grafana.gpg
    /etc/apt/keyrings/grafana.asc
  when: _monitoring_grafana_key.changed or (not _monitoring_grafana_keyring_stat.stat.exists)
  tags: ['monitoring_server']

- name: Remove legacy Grafana APT repo entry (no signed-by)
  ansible.builtin.apt_repository:
    repo: "deb https://apt.grafana.com stable main"
    state: absent
  tags: ['monitoring_server']

- name: Add Grafana APT repo (signed-by keyring)
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main"
    filename: grafana
    state: present
  tags: ['monitoring_server']

- name: Install Grafana
  ansible.builtin.apt:
    name: grafana
    state: present
    update_cache: true
    lock_timeout: "{{ apt_lock_timeout | default(600) | int }}"
  tags: ['monitoring_server']

- name: Configure Grafana HTTP listen address/port
  ansible.builtin.ini_file:
    path: /etc/grafana/grafana.ini
    section: server
    option: "{{ item.option }}"
    value: "{{ item.value }}"
    backup: true
  loop:
    - { option: "http_addr", value: "{{ grafana_http_addr }}" }
    - { option: "http_port", value: "{{ grafana_http_port }}" }
  notify: Restart Grafana
  tags: ['monitoring_server']

- name: Set Grafana admin password (grafana.ini)
  ansible.builtin.lineinfile:
    path: /etc/grafana/grafana.ini
    regexp: '^;?admin_password ='
    line: "admin_password = {{ grafana_admin_password }}"
    backup: true
  notify: Restart Grafana
  no_log: true
  tags: ['monitoring_server']

- name: Reset Grafana admin password via grafana-cli
  ansible.builtin.command: /usr/sbin/grafana-cli admin reset-admin-password "{{ grafana_admin_password }}"
  register: grafana_reset_pw
  changed_when: (grafana_reset_pw.rc == 0) or ('Admin password changed' in (grafana_reset_pw.stdout | default('')))
  failed_when: grafana_reset_pw.rc not in [0, 2]  # grafana-cli returns 2 when the password is already the same
  environment:
    PATH: "/usr/sbin:/usr/bin:/bin"
  no_log: true
  tags: ['monitoring_server']

- name: Ensure Grafana data/log ownership is correct
  become: true
  block:
    - name: Ensure Grafana data directory ownership
      ansible.builtin.file:
        path: /var/lib/grafana
        state: directory
        owner: grafana
        group: grafana
        mode: "0750"

    - name: Ensure Grafana SQLite database ownership (when present)
      ansible.builtin.file:
        path: /var/lib/grafana/grafana.db
        owner: grafana
        group: grafana
        mode: "0640"
      failed_when: false

    - name: Ensure Grafana log directory ownership
      ansible.builtin.file:
        path: /var/log/grafana
        state: directory
        owner: grafana
        group: grafana
        mode: "0750"

    - name: Ensure Grafana log file ownership (when present)
      ansible.builtin.file:
        path: /var/log/grafana/grafana.log
        owner: grafana
        group: grafana
        mode: "0640"
      failed_when: false
  tags: ['monitoring_server']

- name: Ensure provisioning dirs
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: grafana
    group: grafana
    mode: "0755"
  loop:
    - /etc/grafana/provisioning/datasources
    - /etc/grafana/provisioning/dashboards
  tags: ['monitoring_server']

- name: Provision Prometheus datasource
  ansible.builtin.template:
    src: grafana-datasource.yml.j2
    dest: /etc/grafana/provisioning/datasources/prometheus.yml
    owner: grafana
    group: grafana
    mode: "0644"
  notify: Restart Grafana
  tags: ['monitoring_server']

- name: Provision dashboard provider
  ansible.builtin.template:
    src: grafana-dashboard-provider.yml.j2
    dest: /etc/grafana/provisioning/dashboards/provider.yml
    owner: grafana
    group: grafana
    mode: "0644"
  notify: Restart Grafana
  tags: ['monitoring_server']

- name: Ensure Grafana enabled and started
  block:
    - name: Start and enable Grafana
      ansible.builtin.service:
        name: grafana-server
        state: started
        enabled: true

    - name: Check Grafana service state
      ansible.builtin.command: systemctl is-active grafana-server
      register: grafana_is_active
      changed_when: false
      failed_when: false

    - name: Fail with Grafana logs when service is not active
      when: (grafana_is_active.stdout | default('') | trim) != 'active'
      block:
        - name: Read Grafana service status
          ansible.builtin.command: systemctl --no-pager --full status grafana-server
          register: grafana_status
          changed_when: false
          failed_when: false

        - name: Read Grafana journal logs
          ansible.builtin.command: journalctl --no-pager -u grafana-server -n 200
          register: grafana_journal
          changed_when: false
          failed_when: false

        - name: Read Grafana log file tail
          ansible.builtin.shell: |
            set -o pipefail
            test -f /var/log/grafana/grafana.log && tail -n 200 /var/log/grafana/grafana.log || true
          args:
            executable: /bin/bash
          register: grafana_log_tail
          changed_when: false
          failed_when: false

        - name: Fail with Grafana troubleshooting output
          ansible.builtin.fail:
            msg: |-
              grafana-server is not active (state={{ grafana_is_active.stdout | default('') | trim }}).

              systemctl status:
              {{ grafana_status.stdout | default('') | trim }}

              journalctl (last 200 lines):
              {{ grafana_journal.stdout | default('') | trim }}

              /var/log/grafana/grafana.log (tail):
              {{ grafana_log_tail.stdout | default('') | trim }}
  tags: ['monitoring_server']
