---
- name: Restart Prometheus
  ansible.builtin.service:
    name: prometheus
    state: restarted

- name: Restart Grafana
  become: true
  ansible.builtin.shell: |
    set -euo pipefail

    if systemctl restart grafana-server; then
      exit 0
    fi

    echo "grafana-server restart failed; collecting diagnostics..." >&2
    systemctl --no-pager --full status grafana-server || true
    journalctl --no-pager -u grafana-server -n 200 || true
    test -f /var/log/grafana/grafana.log && tail -n 200 /var/log/grafana/grafana.log || true
    exit 1
  args:
    executable: /bin/bash
