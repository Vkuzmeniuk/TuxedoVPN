#!/usr/bin/env bash
set -euo pipefail

OUT_DIR="{{ node_exporter_textfile_collector_dir }}"
OUT_FILE="${OUT_DIR}/tuxedovpn_cert_expiry.prom"
TMP_FILE="$(mktemp)"

escape_label() {
  echo -n "$1" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g'
}

emit() {
  local cert_name="$1"
  local cert_path="$2"
  local ok="$3"
  local ts="$4"
  local esc_name
  local esc_path

  esc_name=$(escape_label "$cert_name")
  esc_path=$(escape_label "$cert_path")

  printf 'tuxedovpn_tls_cert_probe_success{cert="%s",path="%s"} %s\n' "$esc_name" "$esc_path" "$ok" >> "$TMP_FILE"
  printf 'tuxedovpn_tls_cert_expiry_timestamp_seconds{cert="%s",path="%s"} %s\n' "$esc_name" "$esc_path" "$ts" >> "$TMP_FILE"
}

cat > "$TMP_FILE" <<'METRICS'
# HELP tuxedovpn_tls_cert_probe_success 1 if certificate file was read and parsed
# TYPE tuxedovpn_tls_cert_probe_success gauge
# HELP tuxedovpn_tls_cert_expiry_timestamp_seconds Certificate notAfter timestamp (UNIX seconds)
# TYPE tuxedovpn_tls_cert_expiry_timestamp_seconds gauge
METRICS

{% for item in tuxedovpn_cert_monitor_entries %}
cert_name="{{ item.name | default('cert') }}"
cert_path="{{ item.path }}"

ok=0
ts=0
if [ -r "$cert_path" ]; then
  enddate=$(openssl x509 -enddate -noout -in "$cert_path" 2>/dev/null | sed 's/^notAfter=//')
  if [ -n "$enddate" ]; then
    ts=$(date -d "$enddate" +%s 2>/dev/null || echo 0)
    if [ "$ts" -gt 0 ] 2>/dev/null; then
      ok=1
    fi
  fi
fi

emit "$cert_name" "$cert_path" "$ok" "$ts"

{% endfor %}

mv -f "$TMP_FILE" "$OUT_FILE"
chmod 0644 "$OUT_FILE"
