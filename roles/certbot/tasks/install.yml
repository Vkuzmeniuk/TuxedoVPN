---
- name: Ensure apt cache is up to date (Debian/Ubuntu)
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
    lock_timeout: "{{ apt_lock_timeout | default(600) | int }}"
  when: ansible_pkg_mgr == "apt"

- name: Install Certbot (APT)
  ansible.builtin.apt:
    name: "{{ [certbot_package] + (certbot_dns_plugin_packages | default([])) }}"
    state: present
    lock_timeout: "{{ apt_lock_timeout | default(600) | int }}"
  when: ansible_pkg_mgr == "apt"

- name: Install Certbot (generic)
  ansible.builtin.package:
    name: "{{ [certbot_package] + (certbot_dns_plugin_packages | default([])) }}"
    state: present
  when: ansible_pkg_mgr != "apt"

- name: Check certbot.timer unit exists (systemd)
  ansible.builtin.command: systemctl list-unit-files certbot.timer --no-legend --no-pager
  register: _certbot_timer_unit
  changed_when: false
  failed_when: false
  when: ansible_service_mgr == "systemd"

- name: Enable and start certbot.timer (auto-renew)
  ansible.builtin.systemd:
    name: certbot.timer
    state: started
    enabled: true
    daemon_reload: true
  when:
    - ansible_service_mgr == "systemd"
    - (_certbot_timer_unit.rc | default(1) | int) == 0
    - "'certbot.timer' in (_certbot_timer_unit.stdout | default(''))"

- name: Ensure webroot directory exists (HTTP-01)
  ansible.builtin.file:
    path: "{{ certbot_webroot_path }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  when: certbot_method == "webroot"

- name: Check whether nginx is active before install (webroot helper)
  ansible.builtin.command: systemctl is-active nginx
  register: _certbot_nginx_active_preinstall
  changed_when: false
  failed_when: false
  when:
    - ansible_service_mgr == "systemd"
    - certbot_method == "webroot"
    - certbot_manage_webroot_nginx | bool

- name: Remember whether nginx was active before install (webroot helper)
  ansible.builtin.set_fact:
    _certbot_nginx_was_active_preinstall: >-
      {{ (_certbot_nginx_active_preinstall.stdout | default('') | trim) == 'active' }}
  changed_when: false
  when:
    - ansible_service_mgr == "systemd"
    - certbot_method == "webroot"
    - certbot_manage_webroot_nginx | bool

- name: Ensure nginx is installed (optional helper for HTTP-01)
  ansible.builtin.package:
    name: nginx
    state: present
  when:
    - certbot_method == "webroot"
    - certbot_manage_webroot_nginx | bool

- name: Write DNS credentials file (when provided)
  ansible.builtin.copy:
    dest: "{{ certbot_dns_credentials_path }}"
    content: "{{ certbot_dns_credentials_content }}"
    owner: root
    group: root
    mode: "0600"
  when:
    - certbot_method == "dns"
    - (certbot_dns_credentials_content | default('') | trim | length) > 0
  no_log: true

