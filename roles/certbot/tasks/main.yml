---
- name: Validate certbot_action
  ansible.builtin.assert:
    that:
      - certbot_action in ["issue", "renew"]
    fail_msg: "certbot_action must be 'issue' or 'renew'."

- name: Autoconfigure certbot parameters (optional)
  ansible.builtin.include_tasks: autoconfig.yml

- name: Install Certbot and prerequisites
  ansible.builtin.include_tasks: install.yml

- name: Install Certbot hooks (optional)
  ansible.builtin.include_tasks: hook.yml
  when: >-
    (certbot_deploy_hook_enable | bool)
    or (
      (certbot_method | default('')) in ["standalone", "webroot"]
      and (certbot_standalone_install_renew_hooks | default(true) | bool)
      and (
        ((certbot_standalone_stop_services | default([])) | length > 0)
        or (certbot_http01_manage_firewall | default(false) | bool)
        or (
          (certbot_method | default('')) == "webroot"
          and (certbot_manage_webroot_nginx | default(false) | bool)
        )
      )
    )

- name: Issue a certificate (certonly)
  ansible.builtin.include_tasks: issue.yml
  when: certbot_action == "issue"

- name: Renew certificates
  ansible.builtin.include_tasks: renew.yml
  when: certbot_action == "renew"
