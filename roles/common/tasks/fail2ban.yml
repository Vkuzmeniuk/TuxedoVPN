---
# Baseline fail2ban configuration.

- name: Configure fail2ban baseline (SSH)
  when: common_fail2ban_enable | default(false) | bool
  block:
    - name: Determine fail2ban banaction from firewall backend
      ansible.builtin.set_fact:
        common_fail2ban_banaction: >-
          {{
            'ufw'
            if (common_firewall_backend_effective | default('ufw')) == 'ufw'
            else (
              'firewallcmd-ipset'
              if (common_firewall_backend_effective | default('ufw')) == 'firewalld'
              else 'iptables-multiport'
            )
          }}

    - name: Ensure fail2ban jail.d directory exists
      ansible.builtin.file:
        path: /etc/fail2ban/jail.d
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Enable SSH jail (sshd)
      ansible.builtin.template:
        src: fail2ban-sshd.local.j2
        dest: /etc/fail2ban/jail.d/sshd.local
        owner: root
        group: root
        mode: "0644"
      notify: Restart fail2ban
