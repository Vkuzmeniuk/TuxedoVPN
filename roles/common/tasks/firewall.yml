---
# Select and apply the firewall backend.

- name: Determine effective firewall backend
  ansible.builtin.set_fact:
    common_firewall_backend_effective: >-
      {{
        (common_firewall_backend | default('auto'))
        if (common_firewall_backend | default('auto')) != 'auto'
        else (
          'ufw'
          if ansible_facts.os_family == 'Debian'
          else (
            'firewalld'
            if ansible_facts.os_family == 'RedHat'
            else 'iptables'
          )
        )
      }}

- name: Build effective firewall rule list (base)
  ansible.builtin.set_fact:
    common_firewall_rules_effective: "{{ ufw_extra_rules | default([]) }}"

- name: Add dynamic firewall rules for RADIUS from VPN hosts (mgmt only)
  ansible.builtin.set_fact:
    common_firewall_rules_effective: "{{ (common_firewall_rules_effective | default([])) + _common_radius_rules }}"
  vars:
    _common_vpn_src_ip: >-
      {{
        (hostvars[item].mgmt_wireguard_wireguard_ip)
        if (hostvars[item].mgmt_wireguard_wireguard_ip is defined) and ((hostvars[item].mgmt_wireguard_wireguard_ip | default('') | trim) | length > 0)
        else (hostvars[item].ansible_host | default(item))
      }}
    _common_radius_rules: >-
      {{
        [
          {
            'action':    'allow',
            'port':      (freeradius_listen_auth_port | default(1812)),
            'proto':     'udp',
            'direction': 'in',
            'route':     false,
            'src':       _common_vpn_src_ip
          },
          {
            'action':    'allow',
            'port':      (freeradius_listen_acct_port | default(1813)),
            'proto':     'udp',
            'direction': 'in',
            'route':     false,
            'src':       _common_vpn_src_ip
          }
        ]
      }}
  loop: "{{ groups['vpn'] | default([]) }}"
  when: "'mgmt' in group_names"

- name: Apply firewall rules (selected backend)
  ansible.builtin.include_tasks: "{{ common_firewall_backend_effective }}.yml"
  when: common_firewall_manage | default(true) | bool
