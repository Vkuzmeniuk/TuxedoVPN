---
- name: Assert Debian/Ubuntu (Grafana APT repo)
  ansible.builtin.assert:
    that:
      - ansible_facts.os_family == "Debian"
    fail_msg: "role loki currently supports Debian/Ubuntu only (installs from https://apt.grafana.com)."

- name: Add Grafana APT key
  ansible.builtin.apt_key:
    url: https://apt.grafana.com/gpg.key
    state: present

- name: Add Grafana APT repo
  ansible.builtin.apt_repository:
    repo: "deb https://apt.grafana.com stable main"
    state: present

- name: Install Loki
  ansible.builtin.apt:
    name: loki
    state: present
    update_cache: true
    lock_timeout: "{{ apt_lock_timeout | default(600) | int }}"

- name: Ensure loki system group exists
  ansible.builtin.group:
    name: loki
    system: true

- name: Ensure loki system user exists
  ansible.builtin.user:
    name: loki
    group: loki
    system: true
    shell: /usr/sbin/nologin
    create_home: false

- name: Ensure Loki storage directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: loki
    group: loki
    mode: "0750"
  loop:
    - "{{ loki_path_prefix }}"
    - "{{ loki_path_prefix }}/chunks"
    - "{{ loki_path_prefix }}/rules"
    - "{{ loki_path_prefix }}/compactor"

- name: Render /etc/loki/config.yml
  ansible.builtin.template:
    src: config.yml.j2
    dest: /etc/loki/config.yml
    owner: root
    group: root
    mode: "0644"
  notify: Restart Loki

- name: Ensure Loki enabled and started
  block:
    - name: Start and enable Loki
      ansible.builtin.service:
        name: loki
        state: started
        enabled: true

    - name: Check Loki service state
      ansible.builtin.command: systemctl is-active loki
      register: loki_is_active
      changed_when: false
      failed_when: false

    - name: Fail with Loki logs when service is not active
      when: (loki_is_active.stdout | default('') | trim) != 'active'
      block:
        - name: Read Loki service status
          ansible.builtin.command: systemctl --no-pager --full status loki
          register: loki_status
          changed_when: false
          failed_when: false

        - name: Read Loki journal logs
          ansible.builtin.command: journalctl --no-pager -u loki -n 200
          register: loki_journal
          changed_when: false
          failed_when: false

        - name: Fail with Loki troubleshooting output
          ansible.builtin.fail:
            msg: |-
              loki is not active (state={{ loki_is_active.stdout | default('') | trim }}).

              systemctl status:
              {{ loki_status.stdout | default('') | trim }}

              journalctl (last 200 lines):
              {{ loki_journal.stdout | default('') | trim }}
