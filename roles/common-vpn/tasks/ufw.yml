- name: Determine active VPN uplink interface
  ansible.builtin.set_fact:
    _common_vpn_uplink_iface: >-
      {{
        (
          vpn_uplink_iface
          | default(public_vpn_uplink_iface, true)
          | default(ansible_default_ipv4.interface, true)
          | default('', true)
        ) | trim
      }}
  tags: [ufw]

- name: Determine active VPN NAT subnets
  ansible.builtin.set_fact:
    _common_vpn_nat_subnets: "{{ vpn_nat_subnets | default(public_vpn_nat_subnets | default([])) }}"
  tags: [ufw]

- name: Determine whether NFQUEUE mangle rules are enabled
  ansible.builtin.set_fact:
    _common_vpn_enable_mangle: "{{ vpn_enable_mangle | default(public_vpn_enable_mangle | default(false)) }}"
    _common_vpn_nat_subnets_unique: "{{ _common_vpn_nat_subnets | default([]) | unique }}"
  tags: [ufw]

# ---------------------------------------------------------------------------
# UFW — baseline rules (SSH + ocserv)
# ---------------------------------------------------------------------------
- name: Check whether UFW is already installed
  ansible.builtin.stat:
    path: /usr/sbin/ufw
  register: _common_vpn_ufw_stat
  changed_when: false
  tags: [ufw]

- name: Ensure UFW is installed (Debian/Ubuntu)
  ansible.builtin.apt:
    name: ufw
    state: present
    update_cache: false
    lock_timeout: "{{ apt_lock_timeout | default(600) | int }}"
  when:
    - ansible_facts.os_family == "Debian"
    - not (_common_vpn_ufw_stat.stat.exists | default(false))
  tags: [ufw]

- name: Ensure UFW is installed (generic)
  ansible.builtin.package:
    name: ufw
    state: present
  when:
    - ansible_facts.os_family != "Debian"
    - not (_common_vpn_ufw_stat.stat.exists | default(false))
  tags: [ufw]

- name: Check UFW before.rules baseline marker
  ansible.builtin.command:
    cmd: grep -F "{{ common_vpn_before_rules_marker }}" /etc/ufw/before.rules
  register: _common_vpn_before_rules_marker_grep
  changed_when: false
  failed_when: false
  tags: [ufw]

- name: Validate UFW before.rules syntax
  ansible.builtin.shell: |
    set -o pipefail
    iptables-restore --test < /etc/ufw/before.rules
  args:
    executable: /bin/bash
  register: _common_vpn_before_rules_syntax_test
  changed_when: false
  failed_when: false
  tags: [ufw]

- name: Install managed UFW before.rules baseline when missing or invalid
  ansible.builtin.template:
    src: ufw-before.rules.j2
    dest: /etc/ufw/before.rules
    owner: root
    group: root
    mode: "0644"
    backup: true
  when: _common_vpn_before_rules_marker_grep.rc != 0 or (_common_vpn_before_rules_syntax_test.rc | default(1)) != 0
  notify: Restart UFW
  tags: [ufw]

# ---------------------------------------------------------------------------
# Optional MANGLE section (NFQUEUE / Suricata). Disabled by default.
# ---------------------------------------------------------------------------
- name: Ensure *mangle section with NFQUEUE (optional)
  ansible.builtin.blockinfile:
    path: /etc/ufw/before.rules
    marker: "# {mark} PRIVATE_VPN_MANGLE"
    insertbefore: BOF
    block: |
      *mangle
      :PREROUTING ACCEPT [0:0]
      :INPUT ACCEPT [0:0]
      :FORWARD ACCEPT [0:0]
      :OUTPUT ACCEPT [0:0]

      -A FORWARD -o {{ _common_vpn_uplink_iface }} -j NFQUEUE --queue-num {{ (vpn_nfqueue_num | default(dpi_suricata_queue_num | default(0))) | int }} --queue-bypass
      -A FORWARD -i {{ _common_vpn_uplink_iface }} -j NFQUEUE --queue-num {{ (vpn_nfqueue_num | default(dpi_suricata_queue_num | default(0))) | int }} --queue-bypass

      COMMIT
    backup: true
  when:
    - _common_vpn_enable_mangle | default(false)
    - (_common_vpn_uplink_iface | default('') | trim) != ""
  notify: Restart UFW
  tags: [ufw]

- name: Remove NFQUEUE mangle section when disabled
  ansible.builtin.blockinfile:
    path: /etc/ufw/before.rules
    marker: "# {mark} PRIVATE_VPN_MANGLE"
    state: absent
  when: not (_common_vpn_enable_mangle | default(false)) or (_common_vpn_uplink_iface | default('') | trim) == ""
  notify: Restart UFW
  tags: [ufw]

- name: Remove legacy VPN-specific blocks
  ansible.builtin.replace:
    path: /etc/ufw/before.rules
    regexp: '(?ms)^# BEGIN {{ item }}\n.*?# END {{ item }}\n?'
    replace: ''
  loop:
    - CLOSED_VPN_FILTER_BLOCK
    - CLOSED_VPN_NAT_RULES
    - CLOSED_VPN_NAT_SKELETON
    - CLOSED_VPN_NAT_TABLE
    - CLOSED_VPN_NAT_SECTION
    - PRIVATE_VPN_NAT_SECTION
  notify: Restart UFW
  tags: [ufw]

# ---------------------------------------------------------------------------
# FILTER — allow forwarding for each VPN subnet
# ---------------------------------------------------------------------------
- name: Insert forward-allow block (*filter)
  ansible.builtin.blockinfile:
    path: /etc/ufw/before.rules
    marker: "# {mark} PRIVATE_VPN_FILTER_BLOCK"
    # Insert before the "handoff" jump to stay within the *filter section
    insertbefore: "^-A ufw-before-forward -j ufw-user-forward$"
    block: |
      {% for net in (_common_vpn_nat_subnets_unique | default([])) %}
      -A ufw-before-forward -s {{ net }} -j ACCEPT
      -A ufw-before-forward -d {{ net }} -j ACCEPT
      {% endfor %}
    backup: true
  when:
    - (_common_vpn_nat_subnets_unique | default([])) | length > 0
    - (_common_vpn_uplink_iface | default('') | trim) != ""
  notify: Restart UFW
  tags: [ufw]

- name: Remove forward-allow block when not required
  ansible.builtin.blockinfile:
    path: /etc/ufw/before.rules
    marker: "# {mark} PRIVATE_VPN_FILTER_BLOCK"
    state: absent
  when: (_common_vpn_nat_subnets_unique | default([])) | length == 0 or (_common_vpn_uplink_iface | default('') | trim) == ""
  notify: Restart UFW
  tags: [ufw]

# ---------------------------------------------------------------------------
# NAT — single section + POSTROUTING MASQUERADE rules
# ---------------------------------------------------------------------------

# The single *nat section is closer to the end of the file
- name: Ensure MASQUERADE rules exist in *nat
  ansible.builtin.blockinfile:
    path: /etc/ufw/before.rules
    marker: "# {mark} PRIVATE_VPN_NAT_POSTROUTING"
    insertafter: "^:POSTROUTING ACCEPT \\[0:0\\]$"
    block: |-
      {% for net in (_common_vpn_nat_subnets_unique | default([])) -%}
      -A POSTROUTING -s {{ net }} -o {{ _common_vpn_uplink_iface }} -j MASQUERADE
      {% endfor -%}
    backup: true
  when:
    - (_common_vpn_nat_subnets_unique | default([])) | length > 0
    - (_common_vpn_uplink_iface | default('') | trim) != ""
  notify: Restart UFW
  tags: [ufw]

- name: Remove MASQUERADE rules when not required
  ansible.builtin.blockinfile:
    path: /etc/ufw/before.rules
    marker: "# {mark} PRIVATE_VPN_NAT_POSTROUTING"
    state: absent
  when: (_common_vpn_nat_subnets_unique | default([])) | length == 0 or (_common_vpn_uplink_iface | default('') | trim) == ""
  notify: Restart UFW
  tags: [ufw]

# ---------------------------------------------------------------------------
# Enable UFW after all edits
# ---------------------------------------------------------------------------
- name: Validate UFW before.rules after edits
  ansible.builtin.shell: |
    set -o pipefail
    iptables-restore --test < /etc/ufw/before.rules
  args:
    executable: /bin/bash
  register: _common_vpn_before_rules_post_edit_test
  changed_when: false
  failed_when: (_common_vpn_before_rules_post_edit_test.rc | default(1) | int) != 0
  tags: [ufw]

- name: Ensure UFW is enabled
  community.general.ufw:
    state: enabled
  tags: [ufw]
  notify: Restart UFW
