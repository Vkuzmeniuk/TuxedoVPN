---
# Reverse proxy for mgmt services (Grafana/Prometheus/Pi-hole) with TLS termination.
#
# Assumed setup:
# - ocserv on mgmt listens on the public IP (vpn_listen_host != 0.0.0.0)
# - this reverse proxy listens on the mgmt VPN gateway IP (e.g. 10.66.100.1:443)
# - clients can reach it only after connecting to the mgmt VPN; DNS records are provided by Pi-hole

mgmt_reverse_proxy_enable: false

mgmt_reverse_proxy_bind_ip: "127.0.0.1"
mgmt_reverse_proxy_https_port: 443

# Base domain for service subdomains.
# Services will be available as:
# - grafana.<base>
# - prometheus.<base>
# - pihole.<base>
# Or set per-service FQDNs (recommended, per host):
# - grafana_domain
# - prometheus_domain
# - pihole_domain
mgmt_reverse_proxy_base_domain: "{{ vpn_domain | default('mgmt.example.local') }}"

mgmt_reverse_proxy_services:
  - name: grafana
    server_name: "{{ grafana_domain | default('grafana.' ~ mgmt_reverse_proxy_base_domain) }}"
    upstream: "http://127.0.0.1:{{ grafana_http_port | default(3000) }}"
  - name: prometheus
    server_name: "{{ prometheus_domain | default('prometheus.' ~ mgmt_reverse_proxy_base_domain) }}"
    upstream: "http://127.0.0.1:9090"
  - name: pihole
    server_name: "{{ pihole_domain | default('pihole.' ~ mgmt_reverse_proxy_base_domain) }}"
    upstream: "http://127.0.0.1:80"
    redirect_root_to: "/admin/"

# TLS mode:
# - selfsigned: generate a local SAN certificate on mgmt
# - certbot: use Let’s Encrypt paths in /etc/letsencrypt/live/<cert_name>/
mgmt_reverse_proxy_tls_mode: "{{ tuxedovpn_tls_mode | default('selfsigned') }}" # selfsigned | certbot

# Certbot/Let’s Encrypt certificate directory name under /etc/letsencrypt/live/
# (defaults to base domain; can be overridden, e.g. "mgmt-services")
mgmt_reverse_proxy_cert_name: "{{ mgmt_reverse_proxy_base_domain }}"

mgmt_reverse_proxy_selfsigned_dir: "/etc/tuxedovpn/pki/mgmt-reverse-proxy"

mgmt_reverse_proxy_letsencrypt_dir: "/etc/letsencrypt/live/{{ mgmt_reverse_proxy_cert_name }}"
mgmt_reverse_proxy_letsencrypt_fullchain: "{{ mgmt_reverse_proxy_letsencrypt_dir }}/fullchain.pem"
mgmt_reverse_proxy_letsencrypt_privkey: "{{ mgmt_reverse_proxy_letsencrypt_dir }}/privkey.pem"

# Certbot integration (optional): auto-issue the reverse proxy certificate when missing.
mgmt_reverse_proxy_cert_auto_issue_enable: true
# You can set a shared default via tuxedovpn_acme_challenge/tuxedovpn_acme_dns_provider (preferred),
# or via legacy tuxedovpn_certbot_method/tuxedovpn_certbot_auth_args,
# or override per role/host with mgmt_reverse_proxy_certbot_* vars.
mgmt_reverse_proxy_certbot_method: >-
  {{
    (
      'dns'
      if (tuxedovpn_acme_challenge | default('') | string | lower) == 'dns'
      else (
        'webroot'
        if (tuxedovpn_acme_challenge | default('') | string | lower) in ['http_webroot', 'http-webroot']
        else (
        'standalone'
        if (tuxedovpn_acme_challenge | default('') | string | lower) == 'http'
        else (tuxedovpn_certbot_method | default('standalone'))
        )
      )
    )
  }}
# dns | webroot | standalone
mgmt_reverse_proxy_certbot_auth_args: "{{ tuxedovpn_certbot_auth_args | default([]) }}"
mgmt_reverse_proxy_certbot_extra_args: "{{ tuxedovpn_certbot_extra_args | default([]) }}"
mgmt_reverse_proxy_certbot_standalone_stop_services:
  - pihole-FTL
  - nginx
  - apache2
