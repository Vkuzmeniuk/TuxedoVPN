ssh_port: 22
common_journald_tuning_enable: true
common_journald_settings:
  Compress: "yes"
  SystemMaxUse: "256M"
  RuntimeMaxUse: "64M"
  MaxRetentionSec: "7day"
common_set_hostname_from_inventory: true
ufw_extra_rules:
  - { port: 443 }
  - { port: 443, proto: udp }  # DTLS (improves VPN throughput vs TCP-only)
  - { port: 1812, proto: udp, direction: out, dest: "{{ mgmt_wireguard_mgmt_ip }}", interface: "{{ mgmt_wireguard_interface }}" }
  - { port: 1813, proto: udp, direction: out, dest: "{{ mgmt_wireguard_mgmt_ip }}", interface: "{{ mgmt_wireguard_interface }}" }
  - { port: 53,   proto: udp, direction: out, dest: "{{ mgmt_wireguard_mgmt_ip }}", interface: "{{ mgmt_wireguard_interface }}" }
  - { port: 3100, proto: tcp, direction: out, dest: "{{ mgmt_wireguard_mgmt_ip }}", interface: "{{ mgmt_wireguard_interface }}" }  # Loki push
  # Allow metrics scraping only from the management server (over WireGuard)
  - { port: 9813, proto: tcp, direction: in, src: "{{ mgmt_wireguard_mgmt_ip }}", interface: "{{ mgmt_wireguard_interface }}" }
  - { port: 9100, proto: tcp, direction: in, src: "{{ mgmt_wireguard_mgmt_ip }}", interface: "{{ mgmt_wireguard_interface }}" }
  - { port: 9812, proto: tcp, direction: in, src: "{{ mgmt_wireguard_mgmt_ip }}", interface: "{{ mgmt_wireguard_interface }}" }
  - { port: "{{ dpi_agent_port | default(9815) }}", proto: tcp, direction: in, src: "{{ mgmt_wireguard_mgmt_ip }}", interface: "{{ mgmt_wireguard_interface }}" }

vpn_cert_use_existing: "{{ (tuxedovpn_tls_mode | default('selfsigned')) == 'certbot' }}"

# When using HTTP-01 (standalone) we keep inbound tcp/80 closed by default and
# open it briefly via iptables only during ACME validation (issue/renew).
certbot_http01_manage_firewall: true

# TLS cert expiry monitoring (node_exporter textfile collector)
tuxedovpn_cert_monitor_paths: >-
  {{
    [
      {
        "name": "ocserv",
        "path": (
          (vpn_cert_use_existing | bool)
          | ternary(
              (vpn_cert_fullchain | default('/etc/letsencrypt/live/' ~ (vpn_domain | default(inventory_hostname)) ~ '/fullchain.pem')),
              (vpn_cert_selfsigned_dir | default('/etc/ocserv/certs')) ~ '/server-cert.pem'
            )
        )
      }
    ]
  }}
vpn_listen_host: "0.0.0.0"
vpn_listen_proxy_proto: false
vpn_radius_accounting: true
vpn_radius_servers:
  # - host: "{{ hostvars['mgmt-srv-01'].ansible_host | default('mgmt-srv-01') }}"
  #   auth_port: 1812
  #   acct_port: 1813
  #   secret: "{{ radius_shared_secret }}"
  # Use the management server WireGuard address for auth and accounting
  - host: "{{ mgmt_wireguard_mgmt_ip }}"
    auth_port: 1812
    acct_port: 1813
    secret: "{{ radius_shared_secret }}"
vpn_radius_nas_identifier: "{{ inventory_hostname }}"
vpn_dns_client_ip: "{{ vpn_network_address | regex_replace('\\.0$', '.1') }}"
vpn_dns_servers:
  - "{{ mgmt_wireguard_mgmt_ip }}"
vpn_ipv4_network: "{{ vpn_network_address }}"
vpn_ipv4_netmask: "255.255.255.0"
vpn_camouflage_enabled: true

vpn_nat_subnets:
  - "{{ vpn_network_address }}/{{ vpn_network_prefix_length | default(24) }}"

# Keep public VPN sessions alive across app backgrounding / network pauses.
# 0 disables idle-based disconnects in ocserv.
vpn_idle_timeout: 0
vpn_mobile_idle_timeout: 0

# Enforce FreeRADIUS blocklist on reconnects:
# ocserv cookies may allow fast reconnects without a new RADIUS authentication.
# Set to 0 to force re-auth on every reconnect (recommended when DPI blocklist is enabled).
vpn_cookie_timeout: 0

# DPI: send VPN forwarded traffic to NFQUEUE (queue 0) for Suricata inspection.
vpn_enable_mangle: true

# DPI: send events to the mgmt webhook for temporary blocking + Telegram.
dpi_mgmt_webhook_url: "http://{{ mgmt_wireguard_mgmt_ip }}:9816/event"

# DPI enforcement tuning: reduce "only on reconnect" behavior by making live disconnects faster
# and keeping IP-based blocks long enough for username resolution.
dpi_agent_enforce_poll_seconds: 1
dpi_agent_enforce_min_interval_seconds: 1
dpi_agent_disconnect_cooldown_seconds: 5
dpi_agent_action_cooldown_seconds: 5
dpi_agent_ip_correlation_seconds: 600
